---
layout:     post
title:      è§„èŒƒçš„æµ‹è¯•ç±»ç¼–å†™
subtitle:   
date:       2019-12-04
author:     å­™ç»§å³°
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - æµ‹è¯•
---
## æ–­è¨€
> ã€å¼ºåˆ¶ã€‘å•å…ƒæµ‹è¯•åº”è¯¥æ˜¯å…¨è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œå¹¶ä¸”éäº¤äº’å¼çš„ã€‚æµ‹è¯•ç”¨ä¾‹é€šå¸¸æ˜¯è¢«å®šæœŸæ‰§è¡Œçš„ï¼Œæ‰§è¡Œè¿‡ç¨‹å¿…é¡»å®Œå…¨è‡ªåŠ¨åŒ–æ‰æœ‰æ„ä¹‰ã€‚è¾“å‡ºç»“æœéœ€è¦äººå·¥æ£€æŸ¥çš„æµ‹è¯•ä¸æ˜¯ä¸€ä¸ªå¥½çš„å•å…ƒæµ‹è¯•ã€‚å•å…ƒæµ‹è¯•ä¸­ä¸å‡†ä½¿ç”¨ System.out æ¥è¿›è¡Œäººè‚‰éªŒè¯ï¼Œå¿…é¡»ä½¿ç”¨ assert æ¥éªŒè¯ã€‚

æ–­è¨€çš„å®ç°å°±æ˜¯åˆ¤æ–­æ˜¯å¦ç¬¦åˆé¢„æœŸ, ä¸ç¬¦åˆå°±æŠ›å¼‚å¸¸.

Java ä¸­æœ‰æä¾› ```assert``` (æ–­è¨€)å…³é”®å­—, ä½†æ˜¯é»˜è®¤æ˜¯ä¸ç”Ÿæ•ˆçš„, éœ€è¦é…ç½®è™šæ‹Ÿæœºå‚æ•° ```-enablesystemassertions / -esa``` å¯ç”¨æ–­è¨€

JUnit ä¸­æœ‰æä¾›æ­¤å·¥å…·ç±»: ```Assert```
å…¶ä¸­éƒ¨åˆ†æ–¹æ³•: 
- ```static public void assertNotNull(Object object) ``` 
- ```static public void assertEquals(Object expected, Object actual)```
- ```static public void assertTrue(boolean condition)```

åœ¨è¿™é‡Œæˆ‘å®‰åˆ©ä¸€ä¸ªæµ‹è¯•æ¡†æ¶ [AssertJ](https://joel-costigliola.github.io/assertj/), è¯¦ç»†çš„æˆ‘å°±ä¸ä»‹ç»äº†, æ€»ä¹‹ AssertJ æœ‰éå¸¸å‹å¥½çš„æ–­è¨€ API.<br><br>

---
## GIVEN - WHEN - THEN

ä¸€ä¸ªæ ‡å‡†æµ‹è¯•ç”¨ä¾‹çš„ä¸‰æ®µå¼ç»“æ„: 
&emsp;&emsp;ç¼–å†™æ—¶ï¼Œæˆ‘ä»¬ä¼šç²¾å¿ƒå‡†å¤‡ä¸€ç»„è¾“å…¥æ•°æ® (Given)ï¼Œç„¶ååœ¨è°ƒç”¨è¡Œä¸ºå (When)ï¼Œæ–­è¨€è¿”å›çš„ç»“æœä¸é¢„æœŸç›¸ç¬¦ (Then)ã€‚<br><br>
---
## æ ‡å‡†åŸåˆ™
> ã€æ¨èã€‘ç¼–å†™å•å…ƒæµ‹è¯•ä»£ç éµå®ˆBCDEåŸåˆ™ï¼Œä»¥ä¿è¯è¢«æµ‹è¯•æ¨¡å—çš„äº¤ä»˜è´¨é‡ã€‚
B:Borderï¼Œè¾¹ç•Œå€¼æµ‹è¯•ï¼ŒåŒ…æ‹¬å¾ªç¯è¾¹ç•Œã€ç‰¹æ®Šå–å€¼ã€ç‰¹æ®Šæ—¶é—´ç‚¹ã€æ•°æ®é¡ºåºç­‰ã€‚
C:Correctï¼Œæ­£ç¡®çš„è¾“å…¥ï¼Œå¹¶å¾—åˆ°é¢„æœŸçš„ç»“æœã€‚
D:Designï¼Œä¸è®¾è®¡æ–‡æ¡£ç›¸ç»“åˆï¼Œæ¥ç¼–å†™å•å…ƒæµ‹è¯•ã€‚
E:Errorï¼Œå¼ºåˆ¶é”™è¯¯ä¿¡æ¯è¾“å…¥(å¦‚:éæ³•æ•°æ®ã€å¼‚å¸¸æµç¨‹ã€ä¸šåŠ¡å…è®¸å¤–ç­‰)ï¼Œå¹¶å¾—åˆ°é¢„æœŸçš„ç»“æœã€‚

ä¸¾ä¸ªæ —å­, å¯¹ä¸‹é¢è¿™ä¸ªæ–¹æ³•è¿›è¡Œæµ‹è¯•
``` java
    public List<Person> handle(Person person) {
        if (person.getAge() < 0) {
            person.setAge(0);
        }
        if (person.getBirth().after(new Date())) {
            throw new RuntimeException("ç”Ÿæ—¥ä¸èƒ½æ™šäºå½“å‰");
        }
        return Collections.singletonList(person);
    }
```
è¾¹ç•Œæµ‹è¯•:
``` java
    @Test
    public void testHandle1() {
        // GIVEN å¹´é¾„å°äº 0
        Person person = new Person(-1, "Sun", new Date());
        // WHEN
        List<Person> list = handle(person);
        // THEN
        Assert.assertEquals(list.get(0).getAge(), 0);
        Assert.assertEquals(list.get(0).getName(), "Sun");
    }

    @Test
    public void testHandle2() {
        // GIVEN: å¯¹è±¡çš„ç”Ÿæ—¥æ™šäºå½“å‰æ—¶é—´
        Person person = new Person(0, "Sun", new Date(System.currentTimeMillis() + 10000));
        RuntimeException exception = null;
        try {
            // WHEN: è°ƒç”¨è¢«æµ‹è¯•æ–¹æ³•
            List<Person> list = handle(person);
        } catch (RuntimeException e) {
            exception = e;
        }
        // THEN: ä¼šæŠ›å‡ºå¼‚å¸¸, ä¸”å¼‚å¸¸ä¿¡æ¯ä¸º: ç”Ÿæ—¥ä¸èƒ½æ™šäºå½“å‰
        Assert.assertEquals("ç”Ÿæ—¥ä¸èƒ½æ™šäºå½“å‰", exception.getMessage());
    }
```
æ­£ç¡®çš„è¾“å…¥:
``` java
    @Test
    public void testHandle3() {
        // GIVEN
        Person person = new Person(21, "Sun", new Date(889804800000L));
        // WHEN
        List<Person> list = handle(person);
        // THEN
        Assert.assertEquals(list.get(0).getAge(), 21);
        Assert.assertEquals(list.get(0).getName(), "Sun");
        Assert.assertEquals(list.get(0).getBirth(), new Date(889804800000L));
    }
```
é”™è¯¯çš„è¾“å…¥:
``` java
    @Test
    public void testHandle3() {
        NullPointerException exception = null;
        // GIVEN
        Person person = null;
        try {
            // WHEN
            List<Person> list = handle(null);
        } catch (NullPointerException e) {
            exception = e;
        }
        // THEN
        Assert.assertNotNull(exception);
    }
```

---
## å¯¹ DAO å±‚çš„æµ‹è¯• / æ•°æ®åº“é›†æˆæµ‹è¯•

> ã€æ¨èã€‘å¯¹äºæ•°æ®åº“ç›¸å…³çš„æŸ¥è¯¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤ç­‰æ“ä½œï¼Œä¸èƒ½å‡è®¾æ•°æ®åº“é‡Œçš„æ•°æ®æ˜¯å­˜åœ¨çš„ï¼Œæˆ–è€…ç›´æ¥æ“ä½œæ•°æ®åº“æŠŠæ•°æ®æ’å…¥è¿›å»ï¼Œè¯·ä½¿ç”¨ç¨‹åºæ’å…¥æˆ–è€…å¯¼å…¥æ•°æ®çš„æ–¹å¼æ¥å‡†å¤‡æ•°æ®ã€‚
ã€æ¨èã€‘å’Œæ•°æ®åº“ç›¸å…³çš„å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥è®¾å®šè‡ªåŠ¨å›æ»šæœºåˆ¶ï¼Œä¸ç»™æ•°æ®åº“é€ æˆè„æ•°æ®ã€‚æˆ–è€…å¯¹å•å…ƒæµ‹è¯•äº§ç”Ÿçš„æ•°æ®æœ‰æ˜ç¡®çš„å‰åç¼€æ ‡è¯†ã€‚

æ¯”å¦‚è¦æµ‹è¯•ä¸€ä¸ªæ ¹æ® id æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•, ä¸èƒ½å‡è®¾ç”¨æˆ·æ˜¯å­˜åœ¨çš„, ç›´æ¥ç”¨åº“é‡Œçš„ id å»æŸ¥è¯¢, å› ä¸ºè¿™æ¡æ•°æ®æ˜¯ä¸ç¨³å®š, ä½ ä¹Ÿä¸çŸ¥é“è°ä»€ä¹ˆæ—¶å€™å°±æŠŠè¿™æ¡æ•°æ®åˆ äº†, è¿™ä¸ªæµ‹è¯•ç±»å°±è·‘ä¸é€šäº†.
åœ¨æµ‹è¯•ä¹‹å‰è¦ç”¨ä»£ç æ’å…¥ä¸€æ¡æ•°æ®, æµ‹è¯•å®Œæˆåå°†æ•°æ®åˆ é™¤. å¦‚æœæ˜¯ SpringBoot çš„æµ‹è¯•ç±»çš„è¯ç›´æ¥åŠ ä¸Š ```@Transactional``` æ³¨è§£å°±å¸®ä½ å®Œæˆäº†å›æ»šæ“ä½œ.<br>

ä¸¾ä¸ªğŸŒ°, æµ‹è¯•ä¸€ä¸ªä¸‹æ¶å•†å“çš„æ–¹æ³•
``` java
@SpringBootTest
@RunWith(SpringRunner.class)
@Transactional
public class GoodsMapperTest {
    @Autowired
    private GoodsMapper goodsMapper;
    /**
     * æ­£ç¡®çš„ä¸‹æ¶
     */
    @Test
    public void testOffShelves1() {
        // GIVEN: å­˜å…¥ä¸€ä¸ªä¸Šæ¶çš„å•†å“
        GoodsDO goods = new GoodsDO("90012", "é‹å­", "42", "ä¸Šæ¶");
        goodsMapper.save(goods);
        // WHEN: æ‰§è¡Œä¸‹æ¶æ–¹æ³•
        goodsMapper.offShelves(goods.getId());
        // THEN: æ­¤å•†å“çŠ¶æ€ä¼šå˜æˆä¸‹æ¶
        GoodsDO dbGoods = goodsMapper.getById(goods.getId);
        Assert.assertEquals(dbGoods.getStatus(), "ä¸‹æ¶");
    }
    /**
     * ä¸‹æ¶å•†å“ id ä¸å­˜åœ¨
     */
    @Test
    public void testOffShelves2() {
        // GIVEN
        int id = 123456;
        // WHEN
        int affected = goodsMapper.offShelves(id);
        // THEN
        Assert.assertEquals(affected, 0);
    }
    /**
     * å‚æ•°ä¸º null
     .....
}
```
---
## å¯¹ Service å±‚çš„æµ‹è¯•
åœ¨ Service å±‚ä¸­å¤§å¤šä¼šæœ‰å¯¹ DAO å±‚çš„è°ƒç”¨, è¿™é‡Œå¦‚æœçœŸçš„è°ƒç”¨äº† DAO å±‚, é‚£å°±ä¸æ˜¯å•å…ƒæµ‹è¯•äº†, å°±å˜æˆäº†é›†æˆæµ‹è¯•, å•å…ƒæµ‹è¯•ç±»åº”è¯¥ä¸ä¾èµ–äºå…¶ä»–æ¨¡å—çš„.
åœ¨æµ‹è¯• Service çš„æ—¶å€™è¦æŠŠå¯¹ DAO å±‚çš„è°ƒç”¨ mock æ‰, è¿™æ ·åœ¨ Service é‡Œå°±ä¸“æ³¨æµ‹è¯• Service ä¸­çš„ä»£ç , æŠŠ DAO è°ƒç”¨ç†è§£æˆå•çº¯çš„æ•°æ®è¾“å…¥å°±è¡Œäº†.

---
## å¯¹ Controller å±‚çš„æµ‹è¯•
å…¶å® Controller é‡ŒåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆä»£ç , ä½†æ˜¯ Spring çš„æ‰§è¡Œæµç¨‹Controller å‰é¢æœ‰ Interceptor, å¦‚æœä»…é€šè¿‡æ³¨å…¥ Controller æ¥æµ‹è¯•ä¼šæ¼æ‰è‡ªå®šä¹‰çš„ Interceptor å’Œ @Valid å‚æ•°éªŒè¯.
MockMVC è§£å†³äº†è¿™ä¸ªé—®é¢˜.<br>
ä¸¾ä¸ª[ğŸŒ° ](https://juejin.im/post/5b694ff7e51d4519475f7fbc) ,ä¿å­˜ç”¨æˆ·
``` java
    @Test
    public void testAddUser() throws Exception {
        User user = new User();
        user.setId(1L);
        user.setName("jamie");
        user.setAge(20);
        mockMvc.perform(post("/add")
            .contentType(MediaType.APPLICATION_JSON)
            .content(JSON.toJSONString(user)))
            .andExpect(status().isOk())
            .andDo(print())
            .andReturn().getResponse().getContentAsString();
    } 
```


---
## ä¸ªäººæ€»ç»“
- å†™æµ‹è¯•ç±»çš„ç›®çš„ä¸ä»…ä»…æ˜¯ä¸ºäº†è‡ªåŠ¨åŒ–æµ‹è¯•, ä¹Ÿæ˜¯ä¸ºäº†ä»¥åçš„é‡æ„, é‡æ„å‰æµ‹è¯•ç±»èƒ½å…¨è·‘é€š, é‡æ„åæµ‹è¯•ç±»ä¹Ÿè¦å…¨éƒ¨èƒ½è·‘é€š, è¿™ä¹Ÿæ˜¯ TDD çš„æ€æƒ³(Red - Green - Refactor).
- æµ‹è¯•ç±»å¾ˆéš¾ç»´æŠ¤:  æµ‹è¯•ç±»å³ä½¿å†™å‡ºäº†èŠ±æ¥äº†, ä¹Ÿä¸ä¸€å®šä¼šå¥½ç»´æŠ¤, ç¨ç¨æ”¹ä¸€ä¸‹ä»£ç , å°±éœ€è¦å†ç»´æŠ¤ä¸€ä¸‹é‚£ä¸ªæ–¹æ³•å½±å“çš„å…¨éƒ¨æµ‹è¯•ç”¨ä¾‹, å¦‚æœçœŸæ­£ä»¥ TDD çš„æ–¹å¼è¿›è¡Œå¼€å‘ä¹Ÿå°±æ²¡æœ‰ç»´æŠ¤æµ‹è¯•ç”¨ä¾‹è¿™ä¸€è¯´äº†
- ç¼–å†™çš„ä»£ç æœ€å¥½èƒ½å¤Ÿç¬¦åˆ SOLID åŸåˆ™, ä½¿æµ‹è¯•å†™èµ·æ¥ç®€å•ä¸€äº›
